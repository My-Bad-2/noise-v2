name: Nightly Release

on:
    schedule:
        - cron: "0 0 * * *"
    workflow_dispatch:

jobs:
    nightly-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get Date
              run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

            - name: Build Podman Image
              run: |
                  podman build -t cpp-build-env -f Containerfile .

            - name: Build Release Preset
              run: |
                  podman run --rm \
                    -v ${{ github.workspace }}:/src \
                    -w /src \
                    cpp-build-env \
                    bash -c "git config --global --add safe.directory /src && cmake -S . --preset x86_64-clang-release && cd build/x86_64-clang-release && make && make install_limine && make iso && make patch_limine"

            - name: Package Artifact
              run: |
                  mkdir release_dist
                  cp build/x86_64-clang-release/noise.iso release_dist/
                  
            # 2. UPDATED STEP: Use the env.DATE variable for Name and Tag
            - name: Create Nightly Release
              uses: softprops/action-gh-release@v1
              with:
                  name: Nightly Build - ${{ env.DATE }}
                  tag_name: nightly-${{ env.DATE }}
                  body: |
                      Automated nightly build.
                      **Date:** ${{ env.DATE }}
                      **Commit:** ${{ github.sha }}
                  files: |
                      release_dist/*
                  prerelease: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}